---
title: "Tutorial 02: Neuron Morphology"
author: "Alexander Bates"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8,
  cache = FALSE
)

# Setup image output directory
img_dir <- "images/tutorial_02"
if (!dir.exists(img_dir)) {
  dir.create(img_dir, recursive = TRUE)
}

# Helper function to save plots
save_plot <- function(plot_obj, name, width = 10, height = 6) {
  filename <- file.path(img_dir, paste0(name, ".png"))
  ggsave(filename, plot_obj, width = width, height = height, dpi = 300, bg = "white")
}
```

```{r packages, include=FALSE}
# Load required packages
source("setup/packages.R")
source("setup/functions.R")
```

## Introduction

The purpose of this tutorial is to examine neuron morphology.

We can visualise neurons, compare their morphological similarity with [NBLAST](https://natverse.org/nat.nblast/), and plot them with their synapses.

To do this, we are going to look at one of the data 'subsets' we have pre-prepared. 

I have subset the synapses and edgelist relevant for a few interesting areas, so let's use one of those.

You can change which subset and dataset to examine, by changing these two variables:

```{r setup_paths}
# Choose dataset and subset
dataset <- "banc_746"
dataset_id <- "banc_746_id"
data_path <- "gs://brain-and-nerve-cord_exports/sjcabs_data"
subset_name <- "front_leg"
neuropil_pattern <- "^LegNp\\(T1\\)|T1|^ProNM-T1|^LNp_T3"

# Detect if using GCS or local path
use_gcs <- grepl("^gs://", data_path)

# Setup GCS filesystem if needed
gcs_fs <- if (use_gcs) setup_gcs_filesystem() else NULL

# Construct paths
meta_path <- construct_path(data_path, dataset, "meta")
skeletons_path <- construct_path(data_path, dataset, "skeletons")

# For subsets, construct paths to pre-filtered files
# Extract base dataset name (e.g., "banc" from "banc_746")
dataset_base <- sub("_[0-9]+$", "", dataset)
subset_dir <- file.path(data_path, dataset_base, subset_name)
edgelist_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_simple_edgelist.feather"))
synapses_path <- file.path(subset_dir, paste0(dataset, "_", subset_name, "_synapses.feather"))

cat("Dataset:", dataset, "\n")
cat("Subset:", subset_name, "\n")
cat("Using GCS:", use_gcs, "\n")
```

But by default, let us look at the front leg neuropil!

This is available for BANC, maleCNS and MANC.

## Read Meta Data

Let's start by reading the meta data for our chosen subset:

```{r load_meta}
# Read the edgelist for this subset to get neuron IDs
edgelist <- read_feather_smart(edgelist_path, gcs_filesystem = gcs_fs)

# Get unique neuron IDs from pre and post columns
subset_ids <- unique(c(edgelist$pre, edgelist$post))
cat("Found", length(subset_ids), "unique neurons in", subset_name, "edgelist\n")

# Read full meta data using streaming approach
meta_full <- read_feather_smart(meta_path, gcs_filesystem = gcs_fs)

# Get proofread neuron IDs (key concept from Tutorial 01!)
proofread_ids <- meta_full[[dataset_id]]

# Filter meta for neurons in this subset
meta <- meta_full %>%
  filter(!!sym(dataset_id) %in% subset_ids)

# Rename ID column to 'id' for consistency
meta <- meta %>%
  rename(id = !!sym(dataset_id))

cat("Loaded", nrow(meta), "neurons in", subset_name, "subset\n")
cat("(From", nrow(meta_full), "total proofread neurons)\n")
head(meta)
```

Let's now plot the neuron counts we have, by their super class:

```{r plot_counts}
# Count neurons by super_class
counts <- meta %>%
  count(super_class, sort = TRUE)

# Create bar plot
p <- ggplot(counts, aes(x = reorder(super_class, n), y = n, fill = super_class)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), hjust = -0.2, size = 3.5) +
  coord_flip() +
  labs(
    title = paste0("Neuron Counts in ", toupper(dataset), " ", subset_name, " Neuropil"),
    x = "Super Class",
    y = "Number of Neurons"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.grid.major.y = element_blank()
  )

save_plot(p, paste0(dataset, "_", subset_name, "_neuron_counts"))
```

That's quite a lot of neurons, but not too many.

Let's make a vector of their IDs.

```{r get_ids}
# Extract neuron IDs
neuron_ids <- meta$id
cat("Total neurons:", length(neuron_ids), "\n")

# Show first few IDs
head(neuron_ids)
```

## Read .swc File

A [.swc file](http://www.neuronland.org/NLMorphologyConverter/MorphologyFormats/SWC/Spec.html) is a format for encoding neuron 'skeleton' structure.

We could work with high-resolution mesh data (not in our Google bucket), but for most tasks a skeleton suffices and is faster.

If you would like to see how to read in mesh data for the BANC project, which enables nice visualisations, see [here](https://flyconnectome.github.io/bancr/reference/banc_read_neuron_meshes.html).

Let's just take one cell type to start, why not DNg12, known to play a role in the control of the front legs during [grooming](https://www.sciencedirect.com/science/article/pii/S0960982221017425).

We can read its .swc file straight from one of the .zip archives we have.

We can visualise it in BANC space, or in its native space if not a BANC neuron. For non-BANC datasets we provide two spaces, because visualising everything in BANC space assists us with co-visualisation. We will see an example of this later.

For now, let's read and plot that neuron!

```{r read_single_neuron}
# Select one neuron ID
meta_dng12 <- meta %>%
  filter(grepl("DNg12", cell_type))
selected_id <- meta_dng12$id[1]  # Take first matching neuron
cat("Selected neuron ID:", selected_id, "\n")

# Read the specific neuron from the ZIP using helper function
# The SWC files are named by neuron ID
swc_name <- paste0(selected_id, ".swc")
neuron <- read_swc_from_zip(
  zip_path = skeletons_path,
  swc_filename = swc_name,
  gcs_filesystem = gcs_fs,
  format = "nat"
)

cat("Loaded neuron with", nrow(neuron$d), "points\n")
summary(neuron)
```

We can also use `rgl` to show the neuron in an interactive 3D window:

```{r plot3d_neuron, rgl=TRUE, webgl=TRUE}
# Clear any previous 3D plots
clear3d()

# Plot the neuron in 3D with rgl
# Note: neuron is now a single neuron object, not a list
plot3d(neuron, col = "darkblue", lwd = 2)

# Add axes and labels
axes3d()
title3d(main = paste("Neuron", selected_id),
        xlab = "X (nm)", ylab = "Y (nm)", zlab = "Z (nm)")

# Save snapshot
rgl.snapshot(file.path(img_dir, paste0(dataset, "_", subset_name, "_neuron_rgl.png")), fmt = "png")
```

We can also use the `plotly` engine with the `natverse`:

```{r plotly_neuron}
# Switch to plotly engine for web-based visualization
options(nat.plotengine = 'plotly')

# Plot with plotly
plot3d(neuron, col = "darkblue", plotengine = 'plotly')

# Switch back to rgl as default
options(nat.plotengine = 'rgl')
```

Fo publication-ready 2D images, see our [nat.ggplot](https://github.com/natverse/nat.ggplot?tab=readme-ov-file) libraries and the tutorial in its  `README`.

## Read Neuropil Meshes

In our `obj` folder, we have some useful neuroanatomical objects!

We can also show the mesh of the BANC brains and ventral nerve cord neuropils, to help contextualise this morphology.

You can find its `.obj` file in our prepared data, and visualise it with our neuron as so.

```
```

Let's fetch both the BANC ventral nerve cord neuropil, and the leg neuropil.

We can show them over our neurons, with a little transparency.

```{r plot_with_neuropil, rgl=TRUE, webgl=TRUE}
# List available OBJ files in the bucket
obj_files <- system(paste("gsutil ls", obj_path), intern = TRUE)

# Find VNC and leg neuropil meshes
vnc_obj <- obj_files[grepl("vnc.*\\.obj$", obj_files, ignore.case = TRUE)][1]
leg_obj <- obj_files[grepl(neuropil_pattern, basename(obj_files))][1]

cat("VNC mesh:", vnc_obj, "\n")
cat("Leg mesh:", leg_obj, "\n")

# Download and read meshes
temp_vnc <- tempfile(fileext = ".obj")
temp_leg <- tempfile(fileext = ".obj")

if (!is.na(vnc_obj) && length(vnc_obj) > 0) {
  system(paste("gsutil cp", vnc_obj, temp_vnc))
  vnc_mesh <- read.obj(temp_vnc)
}

if (!is.na(leg_obj) && length(leg_obj) > 0) {
  system(paste("gsutil cp", leg_obj, temp_leg))
  leg_mesh <- read.obj(temp_leg)
}

# Plot neuron with neuropil meshes
clear3d()

# Plot meshes with transparency
if (exists("vnc_mesh")) {
  shade3d(vnc_mesh, col = "lightgrey", alpha = 0.1)
}
if (exists("leg_mesh")) {
  shade3d(leg_mesh, col = "lightblue", alpha = 0.3)
}

# Plot neuron on top
plot3d(neuron, col = "darkblue", lwd = 2)

title3d(main = paste("Neuron in Neuropil Context"),
        xlab = "X (nm)", ylab = "Y (nm)", zlab = "Z (nm)")

# Save snapshot
rgl.snapshot(file.path(img_dir, paste0(dataset, "_", subset_name, "_neuron_neuropil.png")), fmt = "png")
```

## Transform between template spaces

Different connectomic and light-level anatomical data are collected in different individuals, and their data may be "registered" to different [template brains](https://www.virtualflybrain.org/docs/concepts/bridging/).

This plot shows the common template brains, including connectomic datasets, and the transforms that we have precomputed:

<p align="center">
  <img src="../inst/images/bridging_graph.png" alt="Template Brain Bridging Graph" width="80%">
</p>

In R, these transforms can be accessed via [nat.flybrains](https://natverse.org/nat.flybrains/index.html)

In this workshop, for each dataset we already provide transformed .swc neuron morphology data in the native dataset AND in BANC. Synapse data is given in the native dataset's space (and may be in raw voxels, nanometers or microns).

This enables you to plot things from multiple datasets in BANC easily.

For example, we can switch to looking at the maleCNS data, and read DNg12 neurons from maleCNS. We can then co-plot them in BANC space, with our BANC DNg12 neurons:

```{r coplot_malecns_banc, rgl=TRUE, webgl=TRUE}
# Switch to maleCNS dataset
dataset_male <- "malecns"
dataset_male_id <- "malecns_09_id"

# Read maleCNS meta data
meta_male_path <- construct_path(data_path, dataset_male, "meta")
meta_male_full <- read_feather_smart(meta_male_path, gcs_filesystem = gcs_fs)

# Filter for DNg12 neurons in maleCNS
meta_male_dng12 <- meta_male_full %>%
  filter(grepl("DNg12", cell_class, ignore.case = TRUE))

cat("Found", nrow(meta_male_dng12), "DNg12 neurons in maleCNS\n")

# Construct path to maleCNS skeletons in BANC space
skeletons_male_banc_path <- construct_path(data_path, dataset_male, "skeletons",
                                           space_suffix = "banc_space")

# Read maleCNS neurons (already in BANC space)
# Sample a few for visualization
n_male_sample <- min(5, nrow(meta_male_dng12))
male_swc_names <- paste0(meta_male_dng12$id[1:n_male_sample], ".swc")

cat("Reading", n_male_sample, "maleCNS neurons from BANC space...\n")
neurons_male_banc <- batch_read_swc_from_zip(
  zip_path = skeletons_male_banc_path,
  swc_filenames = male_swc_names,
  gcs_filesystem = gcs_fs,
  format = "neuronlist",
  show_progress = TRUE
)

# Convert to microns
neurons_male_banc_um <- neurons_male_banc / 1000

# Co-plot BANC and maleCNS neurons
clear3d()

# Plot BANC DNg12 neurons in blue
cat("Plotting BANC neurons...\n")
n_banc_plot <- min(5, length(neurons_um))
for (i in 1:n_banc_plot) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 2, add = TRUE)
}

# Plot maleCNS DNg12 neurons in red
cat("Plotting maleCNS neurons...\n")
for (i in 1:length(neurons_male_banc_um)) {
  plot3d(neurons_male_banc_um[[i]], col = "darkred", lwd = 2, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs maleCNS (red) DNg12 Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```

However, if you want do do spatial transforms yourself, you will need to use `nat.templatebrains` and its `xform_brain` function. A bit confusingly, we will also need [bancr](https://github.com/flyconnectome/bancr?tab=readme-ov-file) to complete the bridge to BANC space.

For example, let's read the native MANC neurons

```{r xform_manc_to_banc, rgl=TRUE, webgl=TRUE}
# Download template brain registrations (only needs to be done once)
nat.flybrains::download_jefferislab_registrations()

# Switch to MANC dataset
dataset_manc <- "manc"
dataset_manc_id <- "manc_v1_id"

# Read MANC meta data
meta_manc_path <- construct_path(data_path, dataset_manc, "meta")
meta_manc_full <- read_feather_smart(meta_manc_path, gcs_filesystem = gcs_fs)

# Filter for DNg12 neurons in MANC
meta_manc_dng12 <- meta_manc_full %>%
  filter(grepl("DNg12", cell_class, ignore.case = TRUE))

cat("Found", nrow(meta_manc_dng12), "DNg12 neurons in MANC\n")

# Construct path to MANC skeletons in native MANC space
skeletons_manc_path <- construct_path(data_path, dataset_manc, "skeletons",
                                      space_suffix = paste0(dataset_manc, "_space"))

# Read MANC neurons in native space
n_manc_sample <- min(3, nrow(meta_manc_dng12))
manc_swc_names <- paste0(meta_manc_dng12$id[1:n_manc_sample], ".swc")

cat("Reading", n_manc_sample, "MANC neurons from native space...\n")
manc_dng12 <- batch_read_swc_from_zip(
  zip_path = skeletons_manc_path,
  swc_filenames = manc_swc_names,
  gcs_filesystem = gcs_fs,
  format = "neuronlist",
  show_progress = TRUE
)

# Transform MANC neurons to JRCVNC2018F template brain
cat("Transforming MANC -> JRCVNC2018F...\n")
manc_dng12_jrcvnc2018f <- xform_brain(manc_dng12,
                                      sample = "MANC",
                                      reference = "JRCVNC2018F")

# Transform from JRCVNC2018F to BANC using bancr
cat("Transforming JRCVNC2018F -> BANC...\n")
manc_dng12_banc <- bancr::banc_to_JRC2018F(manc_dng12_jrcvnc2018f,
                                           region = "vnc",
                                           method = "tpsreg",
                                           banc.units = "nm",
                                           inverse = TRUE)

# Convert to microns
manc_dng12_banc_um <- manc_dng12_banc / 1000

# Co-plot MANC neurons with BANC neurons from earlier
clear3d()

# Plot BANC DNg12 neurons in blue
cat("Plotting BANC neurons...\n")
n_banc_plot <- min(5, length(neurons_um))
for (i in 1:n_banc_plot) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 2, add = TRUE)
}

# Plot transformed MANC DNg12 neurons in green
cat("Plotting transformed MANC neurons...\n")
for (i in 1:length(manc_dng12_banc_um)) {
  plot3d(manc_dng12_banc_um[[i]], col = "darkgreen", lwd = 2, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs MANC (green) DNg12 Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

cat("\nNote: MANC neurons were transformed through MANC -> JRCVNC2018F -> BANC\n")
```

You can also `xform_brain` any other data with 3D points, e.g. meshes (`mesh3d` objects), and data frames or matrices (with `x`,`y` and `z` columns), e.g. synapse data.

## NBLAST

Now that we have seen how to visualise the skeleton of one neuron, let's grab all of our neurons from this neuropil and assess how similar they are.

To read all the neurons, we can select just our subset from the `.zip` archive of all skeletons:

```{r read_all_neurons}
# Create list of SWC file names for our neuron IDs
swc_names <- paste0(neuron_ids, ".swc")

# Read neurons from ZIP using batch helper function
# Limit to first 50 for performance in this example
n_sample <- min(50, length(neuron_ids))

cat("Reading", n_sample, "neurons from ZIP archive...\n")
neurons <- batch_read_swc_from_zip(
  zip_path = skeletons_path,
  swc_filenames = swc_names[1:n_sample],
  gcs_filesystem = gcs_fs,
  format = "neuronlist",
  show_progress = TRUE
)

cat("Loaded", length(neurons), "neurons\n")
```

We can now convert them from 1. nm to µm, and 2. to a 'dotprops' vector cloud, and use this to run an [NBLAST](https://natverse.org/nat.nblast/)!

```{r nblast_analysis}
# Convert from nm to um (microns)
neurons_um <- neurons / 1000

# Convert to dotprops (point cloud with tangent vectors)
# This removes connectivity but preserves spatial structure
neurons_dp <- dotprops(neurons_um, resample = 1, k = 5)

cat("Converted to dotprops representation\n")

# Run NBLAST all-by-all comparison
# This computes morphological similarity scores
cat("Running NBLAST (this may take a moment)...\n")
nblast_scores <- nblast_allbyall(neurons_dp)

cat("NBLAST complete!\n")
cat("Score matrix dimensions:", dim(nblast_scores), "\n")
```

Let's visualise the result as a dendrogram:

```{r nblast_dendrogram}
# Perform hierarchical clustering on NBLAST scores
nblast_hc <- nhclust(scoremat = nblast_scores)

# Plot and save dendrogram
png(file.path(img_dir, paste0(dataset, "_", subset_name, "_nblast_dendrogram.png")),
    width = 12, height = 8, units = "in", res = 300)
plot(nblast_hc, labels = FALSE,
     main = "Hierarchical Clustering of Neuron Morphology (NBLAST)",
     xlab = "Neurons", ylab = "Height")
dev.off()

# Also display in notebook
plot(nblast_hc, labels = FALSE,
     main = "Hierarchical Clustering of Neuron Morphology (NBLAST)",
     xlab = "Neurons", ylab = "Height")
```

Great, now let's view ~20 clusters by morphology:

```{r visualize_clusters, rgl=TRUE, webgl=TRUE}
# Cut the dendrogram into k clusters
k <- 20
clusters <- cutree(nblast_hc, k = k)

cat("Divided neurons into", k, "clusters\n")
table(clusters)

# Create a color palette for clusters
cluster_colors <- rainbow(k)

# Plot neurons colored by cluster
clear3d()

for (i in 1:length(neurons_um)) {
  cluster_id <- clusters[i]
  plot3d(neurons_um[[i]], col = cluster_colors[cluster_id],
         lwd = 1, add = TRUE)
}

title3d(main = paste(k, "Morphological Clusters"),
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```

You can try playing with the number of clusters, `k`.

Cool! What do you think all of these neurons do?

## New Dataset (Coming Soon)

*Note: This section demonstrates cross-dataset co-visualisation once additional datasets like maleCNS or MANC have their skeleton data uploaded to the bucket. For now, we'll continue exploring BANC data.*

<!--
When malecns skeleton data is available, you can load it like this:

```{r load_malecns, eval=FALSE}
# Switch to maleCNS dataset
dataset2 <- "malecns"
subset_name2 <- "front_leg"

# Construct paths for maleCNS
base_path2 <- file.path("gs://brain-and-nerve-cord_exports/sjcabs_data", dataset2)
meta_path2 <- file.path(base_path2, paste0(dataset2, "_09_meta.feather"))
# Use banc_space skeletons for co-visualization
skeletons_path2 <- file.path(base_path2, paste0(dataset2, "_banc_space_swc.zip"))

# Read and filter meta data
temp_feather2 <- tempfile(fileext = ".feather")
system(paste("gsutil cp", meta_path2, temp_feather2))
meta2_full <- read_feather(temp_feather2)
unlink(temp_feather2)

meta2 <- meta2_full %>%
  filter(grepl(neuropil_pattern, neuropil, ignore.case = FALSE))
neuron_ids2 <- meta2$id

# Download and read neurons (sample for performance)
temp_zip2 <- tempfile(fileext = ".zip")
system(paste("gsutil cp", skeletons_path2, temp_zip2))

n_sample2 <- min(50, length(neuron_ids2))
swc_names2 <- paste0(neuron_ids2[1:n_sample2], ".swc")
neurons_malecns <- read.neurons(temp_zip2, files = swc_names2, format = "swc")
unlink(temp_zip2)

# Convert to microns
neurons_malecns_um <- neurons_malecns / 1000
```

Then visualize both datasets together:

```{r covisualize, eval=FALSE}
# Plot both datasets together in BANC space
clear3d()

# Plot BANC neurons in blue
for (i in 1:min(20, length(neurons_um))) {
  plot3d(neurons_um[[i]], col = "darkblue", lwd = 1, add = TRUE)
}

# Plot maleCNS neurons in red
for (i in 1:min(20, length(neurons_malecns_um))) {
  plot3d(neurons_malecns_um[[i]], col = "darkred", lwd = 1, add = TRUE)
}

title3d(main = "Co-visualisation: BANC (blue) vs maleCNS (red) Leg Neurons",
        xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")
```
-->

## Your Turn: New Subset

Now try this analysis yourself with a different subset, e.g., antennal lobe!

Simply change the `subset_name` variable at the top of the tutorial and re-run the analysis.


## Extension: Axon-Dendrite Splits (Coming Soon)

For all of our datasets, except BANC right now, we have axon-dendrite splits that have been pre-calculated.

This uses a graph theoretic algorithm from [Schneider-Mizell et al. 2016](https://elifesciences.org/articles/12059) (see the paper).

The method relies on the idea that information runs from input to output synapses, and determines axon versus dendrites by "cutting" the neuron at its major information bottleneck, and observing which half has more input/output.

The `label` column in the underlying `.swc` files gives the compartment.

In addition, the `pre_label` and `post_label` columns in our synapse tables give compartments.

*Note: This section will be available once maleCNS skeleton data with compartment labels is uploaded. Below is the code framework for when that data becomes available.*

<!--
When maleCNS data with compartment labels is available, you can visualize DNa01 neurons like this:

We will look at the neurons DNa01. To do this we must:

1. Read the meta file, filter for DNa01 on `cell_type`
2. Find its IDs, and read them from the `.swc` file `.zip` archive
3. Read these skeletons in, then subset by "label"
4. Visualise these compartments in different colours

Let's use four colours:

- **blue** = dendrite
- **green** = primary dendrite (linker)
- **orange** = axon
- **purple** = primary neurite tract (cell body fiber tract)

```{r compartment_visualization, eval=FALSE, rgl=TRUE, webgl=TRUE}
# Read maleCNS meta data (use full meta, not subset)
full_meta_path <- file.path(base_path2, paste0(dataset2, "_meta.csv"))
temp_csv3 <- tempfile(fileext = ".csv")
system(paste("gsutil cp", full_meta_path, temp_csv3))
malecns_meta <- read_csv(temp_csv3, show_col_types = FALSE)
unlink(temp_csv3)

# Filter for DNa01 neurons
dna01_meta <- malecns_meta %>%
  filter(cell_type == "DNa01")

cat("Found", nrow(dna01_meta), "DNa01 neurons\n")

if (nrow(dna01_meta) > 0) {
  # Get neuron IDs
  dna01_ids <- dna01_meta$id

  # Download and read neurons
  temp_zip3 <- tempfile(fileext = ".zip")
  skeletons_path_malecns <- file.path(base_path2, paste0(dataset2, "_skeletons.zip"))
  system(paste("gsutil cp", skeletons_path_malecns, temp_zip3))

  # Read neurons
  swc_names_dna01 <- paste0(dna01_ids, ".swc")
  dna01_neurons <- read.neurons(temp_zip3, files = swc_names_dna01, format = "swc")

  # Clean up
  unlink(temp_zip3)

  # Convert to microns
  dna01_neurons_um <- dna01_neurons / 1000

  # Define compartment colors
  # label values: 2=dendrite, 3=axon, 4=primary_dendrite, 5=primary_neurite
  compartment_colors <- c(
    "2" = "blue",        # dendrite
    "3" = "orange",      # axon
    "4" = "green",       # primary_dendrite
    "5" = "purple"       # primary_neurite
  )

  # Plot neurons colored by compartment
  clear3d()

  for (i in 1:length(dna01_neurons_um)) {
    neuron <- dna01_neurons_um[[i]]

    # Extract label for each point
    if ("Label" %in% names(neuron$d)) {
      labels <- as.character(neuron$d$Label)

      # Plot each compartment separately
      for (label_val in unique(labels)) {
        idx <- which(labels == label_val)
        if (length(idx) > 0) {
          color <- compartment_colors[label_val]
          if (is.na(color)) color <- "grey"

          # Create temporary neuron with just this compartment
          temp_d <- neuron$d[idx, ]
          plot3d(temp_d[, c("X", "Y", "Z")],
                 type = "l", col = color, lwd = 2, add = TRUE)
        }
      }
    } else {
      # If no label, plot whole neuron in grey
      plot3d(neuron, col = "grey", lwd = 1, add = TRUE)
    }
  }

  title3d(main = "DNa01 Neurons: Compartments",
          xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

  # Add legend (manual)
  cat("\nCompartment colors:\n")
  cat("  Blue = dendrite\n")
  cat("  Green = primary dendrite\n")
  cat("  Orange = axon\n")
  cat("  Purple = primary neurite tract\n")
}
```

We can also see the synapses by this split.

Let's read the `.feather` file in our data subset, and select just those synapses related to our neurons.

Let's use four colours:

- **navy** = input synapse, dendrite
- **cyan** = input synapse, axon
- **pink** = output synapse, dendrite
- **red** = output synapse, axon

```{r compartment_synapses, rgl=TRUE, webgl=TRUE}
if (nrow(dna01_meta) > 0) {
  # Read synapses for DNa01 neurons
  synapses_path_full <- file.path(base_path2, paste0(dataset2, "_synapses.feather"))
  temp_feather2 <- tempfile(fileext = ".feather")
  system(paste("gsutil cp", synapses_path_full, temp_feather2))

  dna01_synapses <- read_feather(temp_feather2) %>%
    filter(pre %in% dna01_ids | post %in% dna01_ids)

  # Clean up
  unlink(temp_feather2)

  cat("Found", nrow(dna01_synapses), "synapses for DNa01 neurons\n")

  # Create synapse classification
  # Determine if input (post) or output (pre)
  # Determine compartment label
  dna01_synapses <- dna01_synapses %>%
    mutate(
      is_output = pre %in% dna01_ids,
      is_input = post %in% dna01_ids,
      compartment = case_when(
        is_output & !is.na(pre_label) ~ pre_label,
        is_input & !is.na(post_label) ~ post_label,
        TRUE ~ NA_real_
      ),
      syn_color = case_when(
        is_input & compartment == 2 ~ "navy",      # input, dendrite
        is_input & compartment == 3 ~ "cyan",      # input, axon
        is_output & compartment == 2 ~ "pink",     # output, dendrite
        is_output & compartment == 3 ~ "red",      # output, axon
        TRUE ~ "grey"
      )
    )

  # Convert to microns
  dna01_synapses <- dna01_synapses %>%
    mutate(x = x / 1000, y = y / 1000, z = z / 1000)

  # Plot synapses on top of neurons
  for (color in c("navy", "cyan", "pink", "red", "grey")) {
    syn_subset <- dna01_synapses %>% filter(syn_color == color)
    if (nrow(syn_subset) > 0) {
      points3d(syn_subset$x, syn_subset$y, syn_subset$z,
               col = color, size = 3)
    }
  }

  title3d(main = "DNa01 Neurons: Compartmental Synapses",
          xlab = "X (µm)", ylab = "Y (µm)", zlab = "Z (µm)")

  # Print legend
  cat("\nSynapse colors:\n")
  cat("  Navy = input synapse, dendrite\n")
  cat("  Cyan = input synapse, axon\n")
  cat("  Pink = output synapse, dendrite\n")
  cat("  Red = output synapse, axon\n")
}
```
-->

## Session Information

```{r session_info}
sessionInfo()
```












